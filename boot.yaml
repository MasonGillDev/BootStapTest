name: MasonBootTest
type: container
profiles:
  - default

source:
  type: image
  mode: pull
  protocol: simplestreams
  server: https://cloud-images.ubuntu.com/releases
  alias: "24.04"

config:
  user.user-data: |
    #cloud-config

    packages:
      - nginx
      - python3.12-venv

    write_files:
      - path: /usr/local/bin/bootstrap.sh
        permissions: "0755"
        content: |
          #!/bin/bash
          LOG=/var/log/bootstrap.log
          exec > >(tee -a $LOG) 2>&1
          echo "=== BOOTSTRAP START $(date) ==="

          echo "Updating packages…"
          apt-get update && apt-get upgrade -y

          echo "Installing git…"
          apt-get install -y git

          echo "Setting up Python venv…"
          
          mkdir -p /home/ubuntu/huggingface_deploy
          cd /home/ubuntu/huggingface_deploy
          python3 -m venv venv
          ./venv/bin/pip install --upgrade pip
          ./venv/bin/pip install flask transformers torch gradio huggingface_hub psutil

          echo "Enabling hf_api.service…"
          systemctl daemon-reload
          systemctl enable hf_api.service
          systemctl start hf_api.service

          echo "=== BOOTSTRAP END $(date) ==="

      - path: /root/welcome.txt
        permissions: "0644"
        content: |
          Hello Mason!

    runcmd:
      - /usr/local/bin/bootstrap.sh
      - echo "first-boot ran at $(date)" >> /var/log/first-boot.log
